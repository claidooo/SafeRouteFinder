<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>
<div id="map"></div>

<script>
    var urlParams = new URLSearchParams(window.location.search);
    var userLat = parseFloat(urlParams.get('lat')) || 14.5823;
    var userLng = parseFloat(urlParams.get('lng')) || 120.9860;
    var destLat, destLng;
    var apiKey = "5b3ce3597851110001cf6248c374c1d74b7c461cb646776b494655f8"; // API Key

    var map = L.map('map').setView([userLat, userLng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    // ğŸ”¹ Set map boundaries
    map.setMaxBounds([
        [14.5780, 120.9810],  // SW corner
        [14.5865, 120.9910]   // NE corner
    ]);

    // ğŸ”¹ User marker
    L.marker([userLat, userLng]).addTo(map)
        .bindPopup("You are here")
        .openPopup();

    var destinationMarker, routeLayer;

    // ğŸ”¹ Click event to select destination
    map.on('click', function(e) {
        destLat = e.latlng.lat;
        destLng = e.latlng.lng;

        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }

        destinationMarker = L.marker([destLat, destLng]).addTo(map)
            .bindPopup("Destination Selected")
            .openPopup();

        console.log("ğŸ“ Destination set:", destLat, destLng);

        // Send destination to Android (if integrated)
        if (typeof Android !== "undefined") {
            Android.sendDestination(destLat, destLng);
        }

        getRoute(userLat, userLng, destLat, destLng);
    });

    // ğŸ”¹ Fetch route from OpenRouteService (WALKING MODE)
    function getRoute(startLat, startLng, endLat, endLng) {
        let url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=${apiKey}&start=${startLng},${startLat}&end=${endLng},${endLat}`;

        console.log("ğŸ”— Fetching walking route from ORS:", url);
        alert("ğŸš¶ Requesting walking route...");

        fetch(url)
            .then(response => {
                console.log("âœ… API Response Status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("âœ… ORS API Response:", data);

                // ğŸš¨ Ensure response contains valid route data
                if (!data.features || data.features.length === 0) {
                    console.error("âŒ No route found!");
                    alert("âš ï¸ No walking route available. Try another destination.");
                    return;
                }

                let coordinates = data.features[0].geometry.coordinates;

                // ğŸš¨ Ensure valid coordinates
                if (!coordinates || coordinates.length < 2) {
                    console.error("âŒ Error: Route has too few points.");
                    alert("âš ï¸ Error: Route is incomplete.");
                    return;
                }

                let latLngs = coordinates.map(coord => [coord[1], coord[0]]);

                // ğŸš¨ Clear previous route
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                // ğŸš¨ Draw new walking route
                routeLayer = L.polyline(latLngs, { color: "green", weight: 5 }).addTo(map);
                console.log("âœ… Walking route drawn successfully!");
                map.fitBounds(routeLayer.getBounds());
            })
            .catch(error => {
                console.error("âŒ Route Fetch Error:", error);
                alert("âš ï¸ Error fetching walking route. Check your internet or API key.");
            });
    }
</script>
</body>
</html>
