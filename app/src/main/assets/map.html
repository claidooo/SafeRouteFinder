<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <style>
        #map { height: 100vh; }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    var urlParams = new URLSearchParams(window.location.search);
    var userLat = parseFloat(urlParams.get('lat')) || 14.5823;
    var userLng = parseFloat(urlParams.get('lng')) || 120.9860;
    var destLat, destLng;
    var apiKey = "5b3ce3597851110001cf6248c374c1d74b7c461cb646776b494655f8";

    var map = L.map('map').setView([userLat, userLng], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18 }).addTo(map);

    map.setMaxBounds([
        [14.5780, 120.9810],
        [14.5865, 120.9910]
    ]);

    L.marker([userLat, userLng]).addTo(map)
        .bindPopup("You are here")
        .openPopup();

    var destinationMarker, routeLayer;

    map.on('click', function(e) {
        destLat = e.latlng.lat;
        destLng = e.latlng.lng;

        if (destinationMarker) {
            map.removeLayer(destinationMarker);
        }

        destinationMarker = L.marker([destLat, destLng]).addTo(map)
            .bindPopup("Destination Selected")
            .openPopup();

        Android.sendDestination(destLat, destLng);
        getRoute(userLat, userLng, destLat, destLng);
    });

    function getRoute(startLat, startLng, endLat, endLng) {
        let url = `https://api.openrouteservice.org/v2/directions/foot-walking?api_key=${apiKey}&start=${startLng},${startLat}&end=${endLng},${endLat}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (!data.routes || data.routes.length === 0) {
                    console.error("❌ No route found!");
                    alert("No route available.");
                    return;
                }

                let coordinates = data.routes[0].geometry.coordinates;
                let latLngs = coordinates.map(coord => [coord[1], coord[0]]);

                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }

                routeLayer = L.polyline(latLngs, { color: "blue", weight: 5 }).addTo(map);
                map.fitBounds(routeLayer.getBounds());
            })
            .catch(error => {
                console.error("❌ Route Fetch Error:", error);
                alert("Error fetching route.");
            });
    }
</script>
</body>
</html>
